<!DOCTYPE html>
<html>
   <head>
      <title>KMDN</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
      <script src="//code.jquery.com/jquery-1.10.2.js"></script>
      <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
      <script type="text/javascript" src="http://www.parsecdn.com/js/parse-latest.js"></script>
      <script type="text/javascript" src="js/parse_lib.js"></script>
      <script type="text/javascript" src="js/kmdn.js"></script>
      <style>
         .center {
         margin: auto;
         width: 60%;
         #border:3px solid #8AC007;
         padding: 10px;
         }
         .outRange{
         margin-top:50px;
         }
         .func {
         margin: 10px;
         }
         #feedback { font-size: 1.4em; }
         #selectable .ui-selecting { background: #FECA40; }
         #selectable .ui-selected { background: #F39814; color: white; }
         #selectable { list-style-type: none; margin: 0; padding: 0; width: 60%; }
         #selectable li { margin: 3px; padding: 0.4em; font-size: 1.4em; height: 18px; }
         #login_btn{
         backgroundColor: #6699ff,
         color: rgb(255, 255, 255),
         }
      </style>
      <script>
        
        
        
        Parse.initialize("mpuTWZgtQanqfCdO8IWJEJbHTZoQq97h6pG2qhGT", "2Xpjqqtz71ab31Hp9jHRARW7t7jaaBjjnZRJy77o");
         function myFacebookLogout()
         {
            console.log(Parse.User.current());
            alert("myFacebookLogout");
            Parse.User.logOut();
            $("#login_btn").show();
            $("#user").html("");
            $("#user_points").html("");
            $("#logout_btn").hide();
            
         }
         function myFacebookLogin()
         {
            var $user;
            function showUserPoint(points)
            {
                $("#user_points").html("點數:" + points)
            }
            function createUser(data)
            {
                 paraList = {
                    "user" : $user['id'], 
                 }
                 callCloud("createUser", paraList, showUserPoint);
            }
             function checkUserId(data)
            {
                console.log(data);
                console.log(data.length);
                if (data.length == 0)
                {
                    createUser(data);
                    
                }
                else
                {
                    console.log(data[0].get("points"));
                    showUserPoint(data[0].get("points"));
                }
            }
            function initUserPoint_ret(data)
            {
                
                console.log(data);
            }
            function initUserPoint(user)
            {
                alert("initUserPoint");
                console.log(user);
                callCloud("initUserPoint", {'user':user['id']}, initUserPoint_ret);
            }
             alert("myFacebookLogin");
              Parse.FacebookUtils.logIn(null, {
               success: function(user) {
                 $user = user;
                 console.log($user);
                 if (!user.existed()) {
                   alert("User signed up and logged in through Facebook!");
                   initUserPoint($user);
                 } else {
                   alert("User logged in through Facebook!");
                   console.log(Parse.User.current());
                 }
                 $("#user").html($user['id']);
                 $("#login_btn").hide();
                 $("#logout_btn").show();
                 // find user point
                 
                 
                 paraList = {
                    "key": "user", 
                    "value" : {
                        __type: "Pointer",
                        className: "_User",
                        objectId: $user['id']
                    },
                 }
                 callCloud("queryUser", paraList, checkUserId);
               },
               error: function(user, error) {
                 alert("User cancelled the Facebook login or did not fully authorize.");
               }
             });
         }
           
               window.fbAsyncInit = function() {
             Parse.FacebookUtils.init({ // this line replaces FB.init({
               appId      : '846091538840474', // Facebook App ID
               status     : true,  // check Facebook Login status
               cookie     : true,  // enable cookies to allow Parse to access the session
               xfbml      : true,  // initialize Facebook social plugins on the page
               version    : 'v2.5' // point to the latest Facebook Graph API version
             });
         
                 // Run code after the Facebook SDK is loaded.
           };
         
               (function(d, s, id){
             var js, fjs = d.getElementsByTagName(s)[0];
             if (d.getElementById(id)) {return;}
             js = d.createElement(s); js.id = id;
             js.src = "//connect.facebook.net/en_US/sdk.js";
             fjs.parentNode.insertBefore(js, fjs);
           }(document, 'script', 'facebook-jssdk'));
           
           
           
           function open_news()
           {
                var kmdn = new Kmdn();
                kmdn.openNews();
           }
           function open_store()
           {
                var kmdn = new Kmdn();
                kmdn.openStore();
           }
           function open_movie()
           {
               var kmdn = new Kmdn();
               kmdn.openMovie();
           }
           function buyGoods()
           {
                alert("buyGoods");
                var kmdn = new Kmdn();
                kmdn.buyGoods($(this).attr("id"), "test");
           }
           function open_trans()
           {
                alert("open_trans");
                var kmdn = new Kmdn();
                kmdn.openTrans();
           }
           function verify_objectId()
           {
                alert("verify_code");
                var kmdn = new Kmdn();
                kmdn.verifyObjectId("vYe0iL2i5F");
           }
           $("document").ready(function(){
             function createButton(buttons)
             {
                 for(var i = 0 ; i < buttons.length ; i++)
                 {
                     console.log(buttons[i]);
                     $("#bts").append($("<button class=\"func\"></button>").html(buttons[i]));
                     
                 }
                 $("button").button();
                 
             }
             
             $( ".selector" ).selectable({
                  selected: function( event, ui ){}
                });
              $( "button" ).button();
              $("#login_btn").css("color",'blue');
              $("#logout_btn").css("color",'blue');
              $("#logout_btn").hide();
              
              $("#kmdn_news").click(open_news);
              $("#kmdn_movie").click(open_movie);
              $("#exchange").click(open_store);
              $(".goods").click(buyGoods);
              $("#kmdn_trans").click(open_trans);
              $("#kmdn_verifyObjectId").click(verify_objectId);
         });
      </script>
   </head>
   <body>
      <div class="w3-padding w3-xlarge w3-teal center outRange">
         <button id="login_btn" onclick="myFacebookLogin()" style="color:#ffffff; background-color:#6699ff;">Login with Facebook</button>
         <label id="user"></label>
        <label id="user_points"></label>
        <button id="logout_btn" onclick="myFacebookLogout()" style="color:#ffffff; background-color:#6699ff;">Logout</button>
      </div>
      <div id="bts" class="w3-container center">
         <ol id="selectable">
            <li class="ui-widget-content" id="kmdn_news">金門日報</li>
            <li class="ui-widget-content" id="exchange">兌換物品</li>
            <li class="ui-widget-content" id="kmdn_movie">金門獅城</li>
            <li class="ui-widget-content goods" id="Jo76pFEnPI" >電影票</li>
            <li class="ui-widget-content goods" id="2lQ9reg5aI" >電影票+爆米花</li>
            <li class="ui-widget-content" id="kmdn_trans">交易紀錄</li>
            <li class="ui-widget-content" id="kmdn_verifyObjectId">驗證代碼</li>
            <li class="ui-widget-content" id="test_module">test Module</li>
            <li class="ui-widget-content">Item 7</li>
         </ol>
      </div>
      <div class="w3-container center">
         <button class="w3-jumbo w3-btn w3-teal">A-1</button>
         <button class="w3-jumbo w3-btn w3-teal">A-2</button>
         <button class="w3-jumbo w3-btn w3-teal">A-3</button>
      </div>
   </body>
</html>